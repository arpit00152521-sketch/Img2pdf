<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MelodyStream - Offline Music & Video Player</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }

        body {
            background: linear-gradient(135deg, #1a1a2e 0%, #16213e 100%);
            color: #fff;
            min-height: 100vh;
            padding-bottom: 80px;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }

        header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 20px 0;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
            margin-bottom: 30px;
        }

        .logo {
            display: flex;
            align-items: center;
            gap: 10px;
            font-size: 28px;
            font-weight: 700;
            color: #4cc9f0;
        }

        .logo i {
            font-size: 32px;
        }

        .player-section {
            flex: 1;
            min-width: 300px;
            background: rgba(255, 255, 255, 0.05);
            border-radius: 20px;
            padding: 25px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2);
            margin-bottom: 30px;
        }

        .player-section h2 {
            margin-bottom: 20px;
            color: #4cc9f0;
            font-size: 22px;
        }

        .player {
            text-align: center;
        }

        .album-art {
            width: 200px;
            height: 200px;
            margin: 0 auto 25px;
            border-radius: 10px;
            overflow: hidden;
            box-shadow: 0 10px 20px rgba(0, 0, 0, 0.3);
            position: relative;
        }

        .album-art img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .offline-badge {
            position: absolute;
            top: 10px;
            right: 10px;
            background: #10b981;
            color: white;
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 12px;
            font-weight: bold;
        }

        .song-info {
            margin-bottom: 25px;
        }

        .song-title {
            font-size: 22px;
            font-weight: 600;
            margin-bottom: 5px;
        }

        .song-artist {
            font-size: 16px;
            color: #aaa;
        }

        .progress-area {
            margin-bottom: 25px;
        }

        .progress-bar {
            height: 6px;
            width: 100%;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 10px;
            margin-bottom: 8px;
            cursor: pointer;
        }

        .progress {
            height: 100%;
            width: 0%;
            background: #4cc9f0;
            border-radius: 10px;
            transition: width 0.1s linear;
        }

        .timer {
            display: flex;
            justify-content: space-between;
            font-size: 14px;
            color: #aaa;
        }

        .controls {
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 20px;
            margin-bottom: 25px;
        }

        .control-btn {
            width: 50px;
            height: 50px;
            border-radius: 50%;
            background: rgba(255, 255, 255, 0.1);
            border: none;
            color: white;
            font-size: 18px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.3s ease;
        }

        .control-btn:hover {
            background: rgba(76, 201, 240, 0.3);
        }

        .play-pause {
            width: 60px;
            height: 60px;
            background: #4cc9f0;
            font-size: 22px;
        }

        .play-pause:hover {
            background: #3aa8d8;
        }

        .volume-control {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-top: 15px;
        }

        .volume-control i {
            color: #aaa;
        }

        #volume-slider {
            flex: 1;
            height: 5px;
            -webkit-appearance: none;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 5px;
            outline: none;
        }

        #volume-slider::-webkit-slider-thumb {
            -webkit-appearance: none;
            width: 18px;
            height: 18px;
            border-radius: 50%;
            background: #4cc9f0;
            cursor: pointer;
        }

        .library-section {
            background: rgba(255, 255, 255, 0.05);
            border-radius: 20px;
            padding: 25px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2);
            margin-bottom: 30px;
        }

        .library-section h2 {
            margin-bottom: 20px;
            color: #4cc9f0;
            font-size: 22px;
        }

        .library-controls {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
            flex-wrap: wrap;
        }

        .library-btn {
            padding: 12px 20px;
            border-radius: 10px;
            border: none;
            background: #10b981;
            color: white;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .library-btn:hover {
            background: #0da271;
        }

        .library-btn.secondary {
            background: rgba(255, 255, 255, 0.1);
        }

        .library-btn.secondary:hover {
            background: rgba(255, 255, 255, 0.2);
        }

        .file-input-container {
            position: relative;
            overflow: hidden;
            display: inline-block;
        }

        #file-input {
            position: absolute;
            left: 0;
            top: 0;
            opacity: 0;
            width: 100%;
            height: 100%;
            cursor: pointer;
        }

        .library-info {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
            padding: 10px;
            background: rgba(255, 255, 255, 0.05);
            border-radius: 10px;
        }

        .library-stats {
            font-size: 14px;
            color: #aaa;
        }

        .playlist {
            max-height: 400px;
            overflow-y: auto;
            padding-right: 10px;
        }

        .playlist::-webkit-scrollbar {
            width: 6px;
        }

        .playlist::-webkit-scrollbar-track {
            background: rgba(255, 255, 255, 0.05);
            border-radius: 10px;
        }

        .playlist::-webkit-scrollbar-thumb {
            background: #4cc9f0;
            border-radius: 10px;
        }

        .playlist-item {
            display: flex;
            align-items: center;
            gap: 15px;
            padding: 15px;
            border-radius: 10px;
            margin-bottom: 10px;
            background: rgba(255, 255, 255, 0.05);
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .playlist-item:hover {
            background: rgba(255, 255, 255, 0.1);
        }

        .playlist-item.active {
            background: rgba(76, 201, 240, 0.2);
            border-left: 4px solid #4cc9f0;
        }

        .playlist-item-icon {
            width: 50px;
            height: 50px;
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 24px;
            background: rgba(76, 201, 240, 0.2);
        }

        .playlist-item-info {
            flex: 1;
        }

        .playlist-item-title {
            font-weight: 500;
            margin-bottom: 5px;
            font-size: 15px;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .playlist-item-artist {
            font-size: 13px;
            color: #aaa;
        }

        .playlist-item-duration {
            font-size: 13px;
            color: #aaa;
        }

        .playlist-item-delete {
            color: #f87171;
            background: none;
            border: none;
            cursor: pointer;
            padding: 5px;
            font-size: 16px;
            border-radius: 5px;
            transition: all 0.3s ease;
        }

        .playlist-item-delete:hover {
            background: rgba(239, 68, 68, 0.2);
        }

        .video-section {
            background: rgba(255, 255, 255, 0.05);
            border-radius: 20px;
            padding: 25px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2);
            margin-bottom: 30px;
        }

        .video-section h2 {
            margin-bottom: 20px;
            color: #4cc9f0;
            font-size: 22px;
        }

        .video-player-container {
            position: relative;
            width: 100%;
            max-width: 800px;
            margin: 0 auto;
            border-radius: 10px;
            overflow: hidden;
            background: #000;
        }

        #video-player {
            width: 100%;
            height: auto;
            max-height: 450px;
            display: block;
        }

        .video-controls {
            display: flex;
            gap: 10px;
            margin-top: 15px;
            justify-content: center;
        }

        .video-playlist {
            margin-top: 20px;
            max-height: 300px;
            overflow-y: auto;
        }

        .no-content {
            text-align: center;
            padding: 40px 20px;
            color: #aaa;
        }

        .no-content i {
            font-size: 48px;
            margin-bottom: 15px;
            color: #4cc9f0;
        }

        .loading {
            text-align: center;
            padding: 20px;
            color: #aaa;
        }

        .loading i {
            font-size: 24px;
            margin-bottom: 10px;
            color: #4cc9f0;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .error-message {
            text-align: center;
            padding: 20px;
            color: #f87171;
            background: rgba(239, 68, 68, 0.1);
            border-radius: 10px;
            margin-top: 20px;
        }

        .success-message {
            text-align: center;
            padding: 20px;
            color: #4ade80;
            background: rgba(74, 222, 128, 0.1);
            border-radius: 10px;
            margin-top: 20px;
        }

        .offline-credits {
            font-size: 12px;
            color: #aaa;
            margin-top: 10px;
            text-align: center;
        }

        .storage-info {
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 12px;
            color: #aaa;
            margin-top: 10px;
            justify-content: center;
        }

        .storage-info i {
            color: #10b981;
        }

        .footer {
            text-align: center;
            margin-top: 40px;
            padding-top: 20px;
            border-top: 1px solid rgba(255, 255, 255, 0.1);
            color: #aaa;
            font-size: 14px;
        }

        .quality-selector {
            margin-top: 15px;
            display: flex;
            align-items: center;
            gap: 10px;
            justify-content: center;
        }

        .quality-selector select {
            padding: 8px 15px;
            border-radius: 8px;
            background: rgba(255, 255, 255, 0.1);
            color: white;
            border: 1px solid rgba(255, 255, 255, 0.2);
            outline: none;
        }

        .mobile-controls {
            display: none;
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            background: rgba(26, 26, 46, 0.95);
            padding: 10px;
            border-top: 1px solid rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(10px);
        }

        @media (max-width: 768px) {
            .mobile-controls {
                display: flex;
                justify-content: space-around;
                align-items: center;
            }
            
            body {
                padding-bottom: 120px;
            }
            
            .library-controls {
                flex-direction: column;
            }
            
            .library-btn {
                width: 100%;
                justify-content: center;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <div class="logo">
                <i class="fas fa-music"></i>
                <span>MelodyStream</span>
            </div>
            <div class="storage-info">
                <i class="fas fa-database"></i>
                <span>Offline Media Player</span>
            </div>
        </header>

        <section class="player-section">
            <h2>Now Playing</h2>
            <div class="player">
                <div class="album-art">
                    <img id="album-art" src="https://images.unsplash.com/photo-1493225457124-a3eb161ffa5f?ixlib=rb-4.0.3&auto=format&fit=crop&w=600&q=80" alt="Album Art">
                    <div class="offline-badge" id="offline-badge">OFFLINE</div>
                </div>
                
                <div class="song-info">
                    <div class="song-title" id="song-title">Your Offline Library</div>
                    <div class="song-artist" id="song-artist">Add music files to begin</div>
                </div>
                
                <div class="progress-area">
                    <div class="progress-bar" id="progress-bar">
                        <div class="progress" id="progress"></div>
                    </div>
                    <div class="timer">
                        <span id="current-time">0:00</span>
                        <span id="duration">0:00</span>
                    </div>
                </div>
                
                <div class="controls">
                    <button class="control-btn" id="prev-btn">
                        <i class="fas fa-step-backward"></i>
                    </button>
                    <button class="control-btn play-pause" id="play-pause-btn">
                        <i class="fas fa-play" id="play-pause-icon"></i>
                    </button>
                    <button class="control-btn" id="next-btn">
                        <i class="fas fa-step-forward"></i>
                    </button>
                </div>
                
                <div class="volume-control">
                    <i class="fas fa-volume-up"></i>
                    <input type="range" id="volume-slider" min="0" max="100" value="70">
                </div>
                
                <div class="offline-credits" id="offline-credits">
                    Offline Music Player - Your Files, Your Control
                </div>
            </div>
        </section>

        <section class="library-section">
            <h2>Music Library</h2>
            
            <div class="library-controls">
                <div class="file-input-container">
                    <button class="library-btn" id="add-music-btn">
                        <i class="fas fa-plus-circle"></i> Add Music Files
                    </button>
                    <input type="file" id="file-input" accept="audio/*,video/*" multiple>
                </div>
                
                <button class="library-btn secondary" id="clear-library-btn">
                    <i class="fas fa-trash"></i> Clear Library
                </button>
                
                <button class="library-btn secondary" id="export-library-btn">
                    <i class="fas fa-download"></i> Export Playlist
                </button>
                
                <button class="library-btn secondary" id="import-library-btn">
                    <i class="fas fa-upload"></i> Import Playlist
                </button>
            </div>
            
            <div class="library-info">
                <div class="library-stats" id="library-stats">
                    <i class="fas fa-music"></i> <span id="music-count">0</span> songs • 
                    <i class="fas fa-film"></i> <span id="video-count">0</span> videos
                </div>
                <div class="library-stats">
                    <i class="fas fa-hdd"></i> <span id="storage-used">0 MB</span> used
                </div>
            </div>
            
            <div class="playlist" id="playlist">
                <div class="no-content" id="no-content-message">
                    <i class="fas fa-cloud-upload-alt"></i>
                    <p>Your library is empty</p>
                    <p style="font-size: 14px; margin-top: 10px;">Add music or video files to start playing</p>
                    <p style="font-size: 12px; margin-top: 5px;">Supports: MP3, WAV, OGG, MP4, AVI, MKV</p>
                </div>
            </div>
        </section>

        <section class="video-section">
            <h2>Video Player</h2>
            
            <div class="video-player-container">
                <video id="video-player" controls>
                    Your browser does not support the video tag.
                </video>
            </div>
            
            <div class="video-controls">
                <button class="library-btn secondary" id="video-fullscreen-btn">
                    <i class="fas fa-expand"></i> Fullscreen
                </button>
                <button class="library-btn secondary" id="video-download-btn">
                    <i class="fas fa-download"></i> Download
                </button>
            </div>
            
            <div class="video-playlist" id="video-playlist">
                <!-- Video files will be listed here -->
            </div>
        </section>

        <div class="footer">
            <p>MelodyStream &copy; 2023 - Offline Media Player</p>
            <p>All media files are stored locally in your browser</p>
            <p style="font-size: 12px; margin-top: 5px;">No internet connection required • No data collection</p>
        </div>
    </div>

    <div class="mobile-controls">
        <div class="mobile-song-info" style="flex: 1; padding: 0 10px;">
            <div style="font-size: 14px; font-weight: 500;" id="mobile-song-title">No media playing</div>
            <div style="font-size: 12px; color: #aaa;" id="mobile-song-artist">Offline Player</div>
        </div>
        <button class="control-btn" id="mobile-play-btn" style="background: #4cc9f0;">
            <i class="fas fa-play" id="mobile-play-icon"></i>
        </button>
    </div>

    <!-- Audio Player -->
    <audio id="audio-player" style="display: none;"></audio>

    <script>
        // Offline Music & Video Player
        // All files are stored locally in browser storage

        // Player elements
        const audioPlayer = document.getElementById('audio-player');
        const videoPlayer = document.getElementById('video-player');
        const playPauseBtn = document.getElementById('play-pause-btn');
        const playPauseIcon = document.getElementById('play-pause-icon');
        const prevBtn = document.getElementById('prev-btn');
        const nextBtn = document.getElementById('next-btn');
        const progressBar = document.getElementById('progress-bar');
        const progress = document.getElementById('progress');
        const currentTimeEl = document.getElementById('current-time');
        const durationEl = document.getElementById('duration');
        const volumeSlider = document.getElementById('volume-slider');
        const songTitle = document.getElementById('song-title');
        const songArtist = document.getElementById('song-artist');
        const albumArt = document.getElementById('album-art');
        const playlistEl = document.getElementById('playlist');
        const videoPlaylistEl = document.getElementById('video-playlist');
        const fileInput = document.getElementById('file-input');
        const clearLibraryBtn = document.getElementById('clear-library-btn');
        const exportLibraryBtn = document.getElementById('export-library-btn');
        const importLibraryBtn = document.getElementById('import-library-btn');
        const videoFullscreenBtn = document.getElementById('video-fullscreen-btn');
        const videoDownloadBtn = document.getElementById('video-download-btn');
        const libraryStats = document.getElementById('library-stats');
        const musicCountEl = document.getElementById('music-count');
        const videoCountEl = document.getElementById('video-count');
        const storageUsedEl = document.getElementById('storage-used');
        const noContentMessage = document.getElementById('no-content-message');
        const mobilePlayBtn = document.getElementById('mobile-play-btn');
        const mobilePlayIcon = document.getElementById('mobile-play-icon');
        const mobileSongTitle = document.getElementById('mobile-song-title');
        const mobileSongArtist = document.getElementById('mobile-song-artist');

        // Player state
        let currentSongIndex = 0;
        let isPlaying = false;
        let isVideoPlaying = false;
        let library = [];
        let currentMediaType = 'audio'; // 'audio' or 'video'
        let currentMediaUrl = '';

        // Initialize player
        function initPlayer() {
            // Load library from localStorage
            loadLibraryFromStorage();
            
            // Set up audio player events
            audioPlayer.addEventListener('timeupdate', updateProgress);
            audioPlayer.addEventListener('loadedmetadata', updateDuration);
            audioPlayer.addEventListener('ended', playNextMedia);
            audioPlayer.addEventListener('error', handleMediaError);
            
            // Set up video player events
            videoPlayer.addEventListener('timeupdate', updateVideoProgress);
            videoPlayer.addEventListener('loadedmetadata', updateVideoDuration);
            videoPlayer.addEventListener('ended', playNextMedia);
            videoPlayer.addEventListener('error', handleMediaError);
            
            // Event listeners
            playPauseBtn.addEventListener('click', togglePlayPause);
            prevBtn.addEventListener('click', playPrevMedia);
            nextBtn.addEventListener('click', playNextMedia);
            
            progressBar.addEventListener('click', setProgress);
            volumeSlider.addEventListener('input', setVolume);
            
            // File input
            fileInput.addEventListener('change', handleFileSelect);
            
            // Library controls
            clearLibraryBtn.addEventListener('click', clearLibrary);
            exportLibraryBtn.addEventListener('click', exportLibrary);
            importLibraryBtn.addEventListener('click', importLibrary);
            
            // Video controls
            videoFullscreenBtn.addEventListener('click', toggleFullscreen);
            videoDownloadBtn.addEventListener('click', downloadCurrentVideo);
            
            // Mobile controls
            mobilePlayBtn.addEventListener('click', togglePlayPause);
            
            // Update UI
            updateLibraryStats();
            renderPlaylist();
            
            console.log("Offline Media Player initialized!");
        }

        // Handle file selection
        function handleFileSelect(event) {
            const files = event.target.files;
            if (files.length === 0) return;
            
            showMessage(`Adding ${files.length} file(s)...`, 'success');
            
            // Process each file
            for (let i = 0; i < files.length; i++) {
                const file = files[i];
                addFileToLibrary(file);
            }
            
            // Reset file input
            event.target.value = '';
            
            // Update UI
            updateLibraryStats();
            renderPlaylist();
        }

        // Add file to library
        function addFileToLibrary(file) {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                
                reader.onload = function(e) {
                    const fileData = {
                        id: Date.now() + Math.random().toString(36).substr(2, 9),
                        name: file.name,
                        type: file.type,
                        size: file.size,
                        data: e.target.result,
                        addedDate: new Date().toISOString(),
                        duration: 0,
                        artist: 'Unknown Artist',
                        title: file.name.replace(/\.[^/.]+$/, ""), // Remove extension
                        isVideo: file.type.startsWith('video/')
                    };
                    
                    // Try to extract metadata
                    if (file.type.startsWith('audio/')) {
                        extractAudioMetadata(fileData);
                    }
                    
                    // Add to library
                    library.push(fileData);
                    
                    // Save to localStorage
                    saveLibraryToStorage();
                    
                    resolve(fileData);
                };
                
                reader.onerror = function(e) {
                    console.error("File read error:", e);
                    reject(e);
                };
                
                // Read as data URL
                reader.readAsDataURL(file);
            });
        }

        // Extract audio metadata
        function extractAudioMetadata(fileData) {
            // Create a temporary audio element to get duration
            const tempAudio = new Audio();
            tempAudio.src = fileData.data;
            
            tempAudio.addEventListener('loadedmetadata', function() {
                fileData.duration = tempAudio.duration;
                saveLibraryToStorage();
                updateLibraryStats();
                renderPlaylist();
            });
        }

        // Save library to localStorage
        function saveLibraryToStorage() {
            try {
                // Convert library to a storage-friendly format
                const storageData = library.map(item => ({
                    ...item,
                    // Truncate very large data URLs if needed
                    data: item.data.length > 500000 ? item.data.substring(0, 500000) + '...[truncated]' : item.data
                }));
                
                localStorage.setItem('melodystream_library', JSON.stringify(storageData));
                console.log("Library saved to storage");
            } catch (error) {
                console.error("Error saving to localStorage:", error);
                showMessage("Storage limit exceeded. Some files may not be saved.", 'error');
            }
        }

        // Load library from localStorage
        function loadLibraryFromStorage() {
            try {
                const savedLibrary = localStorage.getItem('melodystream_library');
                if (savedLibrary) {
                    library = JSON.parse(savedLibrary);
                    console.log(`Loaded ${library.length} items from storage`);
                } else {
                    library = [];
                    console.log("No saved library found");
                }
            } catch (error) {
                console.error("Error loading from localStorage:", error);
                library = [];
            }
        }

        // Update library statistics
        function updateLibraryStats() {
            const audioFiles = library.filter(item => !item.isVideo);
            const videoFiles = library.filter(item => item.isVideo);
            
            musicCountEl.textContent = audioFiles.length;
            videoCountEl.textContent = videoFiles.length;
            
            // Calculate total storage used
            let totalSize = 0;
            library.forEach(item => {
                totalSize += item.size || 0;
            });
            
            const sizeInMB = (totalSize / (1024 * 1024)).toFixed(2);
            storageUsedEl.textContent = `${sizeInMB} MB`;
            
            // Show/hide no content message
            if (library.length === 0) {
                noContentMessage.style.display = 'block';
            } else {
                noContentMessage.style.display = 'none';
            }
        }

        // Render playlist
        function renderPlaylist() {
            playlistEl.innerHTML = '';
            videoPlaylistEl.innerHTML = '';
            
            if (library.length === 0) {
                noContentMessage.style.display = 'block';
                return;
            }
            
            noContentMessage.style.display = 'none';
            
            // Separate audio and video files
            const audioFiles = library.filter(item => !item.isVideo);
            const videoFiles = library.filter(item => item.isVideo);
            
            // Render audio files
            audioFiles.forEach((item, index) => {
                const playlistItem = document.createElement('div');
                playlistItem.className = `playlist-item ${currentSongIndex === index && !currentMediaType === 'video' ? 'active' : ''}`;
                playlistItem.dataset.index = index;
                playlistItem.dataset.type = 'audio';
                
                playlistItem.innerHTML = `
                    <div class="playlist-item-icon">
                        <i class="fas fa-music"></i>
                    </div>
                    <div class="playlist-item-info">
                        <div class="playlist-item-title">${item.title}</div>
                        <div class="playlist-item-artist">${item.artist}</div>
                    </div>
                    <div class="playlist-item-duration">${formatTime(item.duration || 0)}</div>
                    <button class="playlist-item-delete" data-id="${item.id}">
                        <i class="fas fa-times"></i>
                    </button>
                `;
                
                playlistItem.addEventListener('click', (e) => {
                    if (!e.target.classList.contains('playlist-item-delete') && !e.target.parentNode.classList.contains('playlist-item-delete')) {
                        loadMedia(index, 'audio');
                        if (!isPlaying) playMedia();
                    }
                });
                
                // Delete button
                const deleteBtn = playlistItem.querySelector('.playlist-item-delete');
                deleteBtn.addEventListener('click', (e) => {
                    e.stopPropagation();
                    deleteFromLibrary(item.id);
                });
                
                playlistEl.appendChild(playlistItem);
            });
            
            // Render video files
            videoFiles.forEach((item, index) => {
                const videoIndex = audioFiles.length + index;
                const playlistItem = document.createElement('div');
                playlistItem.className = `playlist-item ${currentSongIndex === videoIndex && currentMediaType === 'video' ? 'active' : ''}`;
                playlistItem.dataset.index = videoIndex;
                playlistItem.dataset.type = 'video';
                
                playlistItem.innerHTML = `
                    <div class="playlist-item-icon">
                        <i class="fas fa-film"></i>
                    </div>
                    <div class="playlist-item-info">
                        <div class="playlist-item-title">${item.title}</div>
                        <div class="playlist-item-artist">Video File</div>
                    </div>
                    <div class="playlist-item-duration">${formatTime(item.duration || 0)}</div>
                    <button class="playlist-item-delete" data-id="${item.id}">
                        <i class="fas fa-times"></i>
                    </button>
                `;
                
                playlistItem.addEventListener('click', (e) => {
                    if (!e.target.classList.contains('playlist-item-delete') && !e.target.parentNode.classList.contains('playlist-item-delete')) {
                        loadMedia(videoIndex, 'video');
                        if (!isPlaying) playMedia();
                    }
                });
                
                // Delete button
                const deleteBtn = playlistItem.querySelector('.playlist-item-delete');
                deleteBtn.addEventListener('click', (e) => {
                    e.stopPropagation();
                    deleteFromLibrary(item.id);
                });
                
                videoPlaylistEl.appendChild(playlistItem);
            });
        }

        // Load media by index
        function loadMedia(index, type = 'audio') {
            if (index < 0 || index >= library.length) return;
            
            currentSongIndex = index;
            currentMediaType = type;
            const media = library[index];
            
            // Update player UI
            songTitle.textContent = media.title;
            songArtist.textContent = media.artist || (type === 'video' ? 'Video File' : 'Unknown Artist');
            mobileSongTitle.textContent = media.title;
            mobileSongArtist.textContent = media.artist || (type === 'video' ? 'Video File' : 'Unknown Artist');
            
            // Update album art for audio files
            if (type === 'audio') {
                albumArt.src = 'https://images.unsplash.com/photo-1493225457124-a3eb161ffa5f?ixlib=rb-4.0.3&auto=format&fit=crop&w=600&q=80';
                videoPlayer.style.display = 'none';
                audioPlayer.style.display = 'block';
            } else {
                // For video files, show a video icon
                albumArt.src = 'https://images.unsplash.com/photo-1574269909862-7e1d70bb8078?ixlib=rb-4.0.3&auto=format&fit=crop&w=600&q=80';
                videoPlayer.style.display = 'block';
                audioPlayer.style.display = 'none';
            }
            
            // Load media
            if (type === 'audio') {
                audioPlayer.src = media.data;
                videoPlayer.pause();
                isVideoPlaying = false;
            } else {
                videoPlayer.src = media.data;
                audioPlayer.pause();
                isPlaying = false;
            }
            
            // Reset progress
            progress.style.width = '0%';
            currentTimeEl.textContent = '0:00';
            durationEl.textContent = formatTime(media.duration || 0);
            
            // Update playlist active item
            updateActivePlaylistItem();
            
            // Update play/pause button
            if (type === 'audio') {
                playPauseIcon.classList.remove('fa-pause');
                playPauseIcon.classList.add('fa-play');
                mobilePlayIcon.classList.remove('fa-pause');
                mobilePlayIcon.classList.add('fa-play');
            }
        }

        // Toggle play/pause
        function togglePlayPause() {
            if (currentMediaType === 'audio') {
                if (isPlaying) {
                    pauseMedia();
                } else {
                    playMedia();
                }
            } else {
                if (isVideoPlaying) {
                    pauseMedia();
                } else {
                    playMedia();
                }
            }
        }

        // Play media
        function playMedia() {
            if (library.length === 0) {
                showMessage("No media in library. Add files first.", 'error');
                return;
            }
            
            // If no media is loaded, load the first one
            if (!audioPlayer.src && !videoPlayer.src) {
                if (library.length > 0) {
                    loadMedia(0, library[0].isVideo ? 'video' : 'audio');
                } else {
                    return;
                }
            }
            
            if (currentMediaType === 'audio') {
                audioPlayer.play().then(() => {
                    isPlaying = true;
                    playPauseIcon.classList.remove('fa-play');
                    playPauseIcon.classList.add('fa-pause');
                    mobilePlayIcon.classList.remove('fa-play');
                    mobilePlayIcon.classList.add('fa-pause');
                }).catch(e => {
                    console.log("Play error:", e);
                    showMessage("Click play again to start playback", 'error');
                });
            } else {
                videoPlayer.play().then(() => {
                    isVideoPlaying = true;
                    playPauseIcon.classList.remove('fa-play');
                    playPauseIcon.classList.add('fa-pause');
                    mobilePlayIcon.classList.remove('fa-play');
                    mobilePlayIcon.classList.add('fa-pause');
                }).catch(e => {
                    console.log("Video play error:", e);
                    showMessage("Click play again to start playback", 'error');
                });
            }
        }

        // Pause media
        function pauseMedia() {
            if (currentMediaType === 'audio') {
                isPlaying = false;
                audioPlayer.pause();
            } else {
                isVideoPlaying = false;
                videoPlayer.pause();
            }
            
            playPauseIcon.classList.remove('fa-pause');
            playPauseIcon.classList.add('fa-play');
            mobilePlayIcon.classList.remove('fa-pause');
            mobilePlayIcon.classList.add('fa-play');
        }

        // Play previous media
        function playPrevMedia() {
            let prevIndex = currentSongIndex - 1;
            if (prevIndex < 0) prevIndex = library.length - 1;
            
            const prevMedia = library[prevIndex];
            loadMedia(prevIndex, prevMedia.isVideo ? 'video' : 'audio');
            
            if ((currentMediaType === 'audio' && isPlaying) || (currentMediaType === 'video' && isVideoPlaying)) {
                playMedia();
            }
        }

        // Play next media
        function playNextMedia() {
            let nextIndex = currentSongIndex + 1;
            if (nextIndex >= library.length) nextIndex = 0;
            
            const nextMedia = library[nextIndex];
            loadMedia(nextIndex, nextMedia.isVideo ? 'video' : 'audio');
            
            if ((currentMediaType === 'audio' && isPlaying) || (currentMediaType === 'video' && isVideoPlaying)) {
                playMedia();
            }
        }

        // Update progress for audio
        function updateProgress() {
            const { currentTime, duration } = audioPlayer;
            if (duration > 0) {
                const progressPercent = (currentTime / duration) * 100;
                progress.style.width = `${progressPercent}%`;
                
                // Update current time
                currentTimeEl.textContent = formatTime(currentTime);
                durationEl.textContent = formatTime(duration);
            }
        }

        // Update progress for video
        function updateVideoProgress() {
            const { currentTime, duration } = videoPlayer;
            if (duration > 0) {
                const progressPercent = (currentTime / duration) * 100;
                progress.style.width = `${progressPercent}%`;
                
                // Update current time
                currentTimeEl.textContent = formatTime(currentTime);
                durationEl.textContent = formatTime(duration);
            }
        }

        // Update duration
        function updateDuration() {
            if (audioPlayer.duration && audioPlayer.duration > 0) {
                durationEl.textContent = formatTime(audioPlayer.duration);
            }
        }

        // Update video duration
        function updateVideoDuration() {
            if (videoPlayer.duration && videoPlayer.duration > 0) {
                durationEl.textContent = formatTime(videoPlayer.duration);
            }
        }

        // Set progress on click
        function setProgress(e) {
            const width = this.clientWidth;
            const clickX = e.offsetX;
            
            if (currentMediaType === 'audio') {
                const duration = audioPlayer.duration;
                if (duration > 0) {
                    audioPlayer.currentTime = (clickX / width) * duration;
                }
            } else {
                const duration = videoPlayer.duration;
                if (duration > 0) {
                    videoPlayer.currentTime = (clickX / width) * duration;
                }
            }
        }

        // Set volume
        function setVolume() {
            const volume = volumeSlider.value / 100;
            audioPlayer.volume = volume;
            videoPlayer.volume = volume;
        }

        // Delete from library
        function deleteFromLibrary(id) {
            const index = library.findIndex(item => item.id === id);
            if (index !== -1) {
                library.splice(index, 1);
                saveLibraryToStorage();
                updateLibraryStats();
                renderPlaylist();
                
                // If we deleted the currently playing item, stop playback
                if (index === currentSongIndex) {
                    if (currentMediaType === 'audio') {
                        audioPlayer.pause();
                        isPlaying = false;
                    } else {
                        videoPlayer.pause();
                        isVideoPlaying = false;
                    }
                    playPauseIcon.classList.remove('fa-pause');
                    playPauseIcon.classList.add('fa-play');
                    mobilePlayIcon.classList.remove('fa-pause');
                    mobilePlayIcon.classList.add('fa-play');
                }
                
                showMessage("File removed from library", 'success');
            }
        }

        // Clear library
        function clearLibrary() {
            if (library.length === 0) {
                showMessage("Library is already empty", 'error');
                return;
            }
            
            if (confirm(`Are you sure you want to clear your library? This will remove ${library.length} file(s).`)) {
                library = [];
                saveLibraryToStorage();
                updateLibraryStats();
                renderPlaylist();
                
                // Stop playback
                audioPlayer.pause();
                videoPlayer.pause();
                isPlaying = false;
                isVideoPlaying = false;
                playPauseIcon.classList.remove('fa-pause');
                playPauseIcon.classList.add('fa-play');
                mobilePlayIcon.classList.remove('fa-pause');
                mobilePlayIcon.classList.add('fa-play');
                
                showMessage("Library cleared", 'success');
            }
        }

        // Export library
        function exportLibrary() {
            if (library.length === 0) {
                showMessage("Library is empty", 'error');
                return;
            }
            
            // Create export data
            const exportData = {
                version: '1.0',
                exportDate: new Date().toISOString(),
                itemCount: library.length,
                library: library.map(item => ({
                    ...item,
                    // Don't include data URLs in export to keep file size small
                    data: undefined
                }))
            };
            
            // Create download link
            const dataStr = JSON.stringify(exportData, null, 2);
            const dataUri = 'data:application/json;charset=utf-8,'+ encodeURIComponent(dataStr);
            
            const exportFileDefaultName = `melodystream_library_${new Date().toISOString().slice(0,10)}.json`;
            
            const linkElement = document.createElement('a');
            linkElement.setAttribute('href', dataUri);
            linkElement.setAttribute('download', exportFileDefaultName);
            linkElement.click();
            
            showMessage("Library exported successfully", 'success');
        }

        // Import library
        function importLibrary() {
            // Create file input for JSON import
            const input = document.createElement('input');
            input.type = 'file';
            input.accept = '.json';
            
            input.onchange = function(e) {
                const file = e.target.files[0];
                if (!file) return;
                
                const reader = new FileReader();
                reader.onload = function(e) {
                    try {
                        const importData = JSON.parse(e.target.result);
                        
                        // Check if it's a valid export file
                        if (!importData.library || !Array.isArray(importData.library)) {
                            throw new Error("Invalid library file format");
                        }
                        
                        // Merge with existing library
                        const oldCount = library.length;
                        importData.library.forEach(item => {
                            // Check for duplicates
                            const exists = library.some(libItem => libItem.name === item.name && libItem.size === item.size);
                            if (!exists) {
                                library.push({
                                    ...item,
                                    id: Date.now() + Math.random().toString(36).substr(2, 9)
                                });
                            }
                        });
                        
                        saveLibraryToStorage();
                        updateLibraryStats();
                        renderPlaylist();
                        
                        const newItems = library.length - oldCount;
                        showMessage(`Imported ${newItems} new item(s)`, 'success');
                    } catch (error) {
                        console.error("Import error:", error);
                        showMessage("Failed to import library file", 'error');
                    }
                };
                
                reader.readAsText(file);
            };
            
            input.click();
        }

        // Toggle fullscreen for video
        function toggleFullscreen() {
            if (!document.fullscreenElement) {
                videoPlayer.requestFullscreen().catch(err => {
                    console.error(`Error attempting to enable fullscreen: ${err.message}`);
                });
            } else {
                document.exitFullscreen();
            }
        }

        // Download current video
        function downloadCurrentVideo() {
            if (currentMediaType !== 'video') {
                showMessage("No video is currently playing", 'error');
                return;
            }
            
            const currentMedia = library[currentSongIndex];
            if (!currentMedia || !currentMedia.data) {
                showMessage("Cannot download this video", 'error');
                return;
            }
            
            const link = document.createElement('a');
            link.href = currentMedia.data;
            link.download = currentMedia.name;
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        }

        // Handle media errors
        function handleMediaError(e) {
            console.error("Media error:", e);
            showMessage("Error playing media. Trying next...", 'error');
            
            // Try next media after a delay
            setTimeout(() => {
                if (library.length > 1) {
                    playNextMedia();
                }
            }, 1000);
        }

        // Update active playlist item
        function updateActivePlaylistItem() {
            document.querySelectorAll('.playlist-item').forEach((item, index) => {
                const itemIndex = parseInt(item.dataset.index);
                const itemType = item.dataset.type;
                
                if (itemIndex === currentSongIndex && 
                    ((currentMediaType === 'audio' && itemType === 'audio') || 
                     (currentMediaType === 'video' && itemType === 'video'))) {
                    item.classList.add('active');
                } else {
                    item.classList.remove('active');
                }
            });
        }

        // Format time (seconds to mm:ss)
        function formatTime(seconds) {
            if (isNaN(seconds) || seconds === 0) return "--:--";
            
            const min = Math.floor(seconds / 60);
            const sec = Math.floor(seconds % 60);
            return `${min}:${sec < 10 ? '0' : ''}${sec}`;
        }

        // Show message
        function showMessage(message, type = 'info') {
            // Remove existing messages
            const existingError = document.querySelector('.error-message');
            const existingSuccess = document.querySelector('.success-message');
            if (existingError) existingError.remove();
            if (existingSuccess) existingSuccess.remove();
            
            const messageEl = document.createElement('div');
            messageEl.className = type === 'error' ? 'error-message' : 'success-message';
            
            const icon = type === 'error' ? 'fa-exclamation-circle' : 'fa-check-circle';
            messageEl.innerHTML = `<i class="fas ${icon}"></i> ${message}`;
            
            // Insert after library controls
            const librarySection = document.querySelector('.library-section');
            librarySection.insertBefore(messageEl, librarySection.children[3]);
            
            // Auto remove after 5 seconds
            setTimeout(() => {
                if (messageEl.parentNode) {
                    messageEl.remove();
                }
            }, 5000);
        }

        // Initialize when page loads
        window.addEventListener('DOMContentLoaded', initPlayer);
    </script>
</body>
    </html>
